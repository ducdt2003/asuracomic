<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple Comments</title>
    <link rel="stylesheet" href="/css/web/web-main/detail.css" />

</head>
<body>
<div class="comments-container">
    <h2>Comments</h2>

    <!-- Success/Error Messages -->
    <div th:if="${message}" class="success-message" th:text="${message}"></div>
    <div th:if="${error}" class="error-message" th:text="${error}"></div>

    <!-- Login Prompt -->
    <div class="login-prompt" th:if="${!isLoggedIn}">
        <p>Log in to join the conversation <a th:href="@{/asura/login}">Log in</a></p>
    </div>

    <!-- Comment Input -->
    <div class="comment-input" th:if="${isLoggedIn}">
        <form th:action="@{/asura/comic/{comicSlug}/chapter/{chapterSlug}/comment(comicSlug=${comic.slug},chapterSlug=${chapter.slug})}"
              th:object="${newComment}" method="post">
            <textarea th:field="*{content}" placeholder="Write a comment…" required></textarea>
            <div class="comment-toolbar">
                <button type="submit">Post Comment</button>
            </div>
        </form>
    </div>

    <!-- Comment List -->
    <ul class="comment-list">
        <li class="comment-item" th:each="comment : ${comments}">
            <div class="user-info">
                <img th:src="${comment.user.avatar != null} ? ${comment.user.avatar} : 'https://asuracomic.net/images/logo.webp'" class="avatar"/>
                <strong class="username" th:text="${comment.user.username}">Username</strong>
                - <i class="fas fa-crown"
                     th:style="${comment.user.vipStatus ? 'color: gold;' : 'color: #6a5acd;'}"></i>
                <span th:text="${comment.user.vipStatus ? 'VIP' : 'Thường'}"
                      th:style="${comment.user.vipStatus ? 'color: gold; font-weight: bold;' : 'color: #6a5acd; font-weight: bold;'}">
</span>

                <span class="timestamp"
                      th:text="${#temporals.format(comment.createdAt, 'd MMM yyyy')}">Time</span>
            </div>

            <div class="comment-text" th:text="${comment.content}">Comment content</div>

            <div class="comment-actions" th:if="${isLoggedIn}">
                <!-- Nếu là chủ sở hữu bình luận -->
                <div th:if="${comment.user.id == currentUserId}">
                    <form th:action="@{/asura/comic/{comicSlug}/chapter/{chapterSlug}/comment/{commentId}/delete(
                comicSlug=${comic.slug},
                chapterSlug=${chapter.slug},
                commentId=${comment.id}
            )}" method="post" style="display: inline;">
                        <button type="submit" class="action-btn"
                                onclick="return confirm('Xác nhận xóa bình luận?')"
                                style="background-color: #ff4d4d; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; transition: background-color 0.3s ease;">
                            Xóa
                        </button>
                    </form>
                    <a th:href="@{/asura/report(commentId=${comment.id})}" class="action-btn"
                       style="background-color: #ff4d4d; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; transition: background-color 0.3s ease;">
                        Báo cáo
                    </a>
                </div>

                <!-- Nếu không phải chủ sở hữu -->
                <div th:if="${comment.user.id != currentUserId}">
                    <a th:href="@{/asura/report(commentId=${comment.id})}"
                       class="action-btn"
                       style="background-color: #ff4d4d; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; transition: background-color 0.3s ease;">
                        Báo cáo
                    </a>

                </div>
            </div>

        </li>
    </ul>





    <!-- Pagination -->
    <div class="pagination" th:if="${totalCommentPages > 1}">
        <a th:href="@{/asura/comic/{comicSlug}/chapter/{chapterSlug}(comicSlug=${comic.slug},chapterSlug=${chapter.slug},commentPage=${commentPage - 1},commentSize=${commentSize})}"
           th:classappend="${commentPage == 0} ? 'prev-btn disabled' : 'prev-btn'"
           style="display:inline-block; padding:8px 16px; margin-right:8px; background-color:#007bff; color:#fff; text-decoration:none; border-radius:5px; font-weight:600; cursor:pointer;
              border: none; user-select:none;"
           onmouseover="if(!this.classList.contains('disabled')) this.style.backgroundColor='#0056b3';"
           onmouseout="if(!this.classList.contains('disabled')) this.style.backgroundColor='#007bff';"
           th:attr="onclick=${commentPage == 0} ? 'return false;' : null"
        >
            Previous
        </a>
        <a th:href="@{/asura/comic/{comicSlug}/chapter/{chapterSlug}(comicSlug=${comic.slug},chapterSlug=${chapter.slug},commentPage=${commentPage + 1},commentSize=${commentSize})}"
           th:classappend="${commentPage + 1 >= totalCommentPages} ? 'next-btn disabled' : 'next-btn'"
           style="display:inline-block; padding:8px 16px; background-color:#007bff; color:#fff; text-decoration:none; border-radius:5px; font-weight:600; cursor:pointer;
              border: none; user-select:none;"
           onmouseover="if(!this.classList.contains('disabled')) this.style.backgroundColor='#0056b3';"
           onmouseout="if(!this.classList.contains('disabled')) this.style.backgroundColor='#007bff';"
           th:attr="onclick=${commentPage + 1 >= totalCommentPages} ? 'return false;' : null"
        >
            Next
        </a>
    </div>

</div>
</body>

<!-- JavaScript for Comment Actions -->
<script>
    function toggleReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleEditForm(commentId) {
        const form = document.getElementById('edit-form-' + commentId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function toggleReportForm(commentId) {
        const form = document.getElementById('report-form-' + commentId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function deleteComment(commentId, comicSlug, chapterSlug) {
        if (confirm('Are you sure you want to delete this comment?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/asura/comic/' + comicSlug + '/chapter/' + chapterSlug + '/comment/' + commentId + '/delete';
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Back to Top Script
    window.addEventListener('scroll', function() {
        const backToTopButton = document.querySelector('.back-to-top');
        if (window.scrollY > 300) {
            backToTopButton.classList.add('show');
        } else {
            backToTopButton.classList.remove('show');
        }
    });

    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
</script>
</html>
